{% extends 'base.html' %}

{% block title %}Search Documents{% endblock %}

{% block content %}
<div class="bg-white dark:bg-gray-800 shadow-lg dark:shadow-none rounded-xl overflow-hidden flex flex-col" style="height: calc(100vh - 4rem);">
    <!-- Header with Search Bar -->
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Document Search</h1>
        <form id="search-form" class="mt-4">
            <div class="flex items-center gap-2 flex-wrap">
                <div class="relative flex-grow">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                        <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                        </svg>
                    </div>
                    <input type="search" id="keyword" name="keyword" class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Enter keywords and press Enter...">
                </div>
                <select id="conversion_type_filter" name="conversion_type_filter" class="p-4 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    <option value="" selected>All Conversion Types</option>
                </select>
                <div class="relative">
                    <button type="button" id="file_type_dropdown_btn" class="p-4 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 dark:bg-gray-700 dark:text-white flex items-center gap-1">
                        File Types
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="file_type_dropdown" class="hidden absolute z-20 mt-2 w-64 max-h-72 overflow-y-auto bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-2 space-y-1 text-sm">
                        <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 px-1">File Types</div>
                        <div id="file_type_list" class="space-y-1"></div>
                        <div class="pt-2 border-t border-gray-200 dark:border-gray-600 flex gap-2">
                            <button type="button" id="file_type_clear" class="flex-1 py-1 text-xs bg-gray-100 dark:bg-gray-600 rounded hover:bg-gray-200 dark:hover:bg-gray-500">Clear</button>
                            <button type="button" id="file_type_apply" class="flex-1 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Apply</button>
                        </div>
                    </div>
                </div>
                <select id="source_filter" name="source_filter" class="p-4 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    <option value="" selected>All Sources</option>
                </select>
                <select id="search_type" name="search_type" class="p-4 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    <option value="full_text" selected>全文检索（PGroonga）</option>
                    <option value="trigram">模糊检索（Trigram）</option>
                </select>
                <button type="button" onclick="performSearch()" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-6 py-4 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Search</button>
            </div>
        </form>
    </div>

    <!-- Results Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <div class="p-6 text-sm text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
            <div id="results-summary">Enter a query to see results.</div>
        </div>
        <div id="results-container" class="flex-1 overflow-y-auto custom-scrollbar divide-y divide-gray-200 dark:divide-gray-700">
            <!-- Results will be injected here by JavaScript -->
        </div>
        <div id="pagination-container" class="p-4 bg-gray-50 dark:bg-gray-800/50 flex justify-center border-t border-gray-200 dark:border-gray-700">
            <!-- Pagination will be injected here by JavaScript -->
        </div>
    </div>
</div>


<!-- Modal for Markdown Preview -->
<div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 id="modal-title" class="text-xl font-semibold text-gray-800 dark:text-gray-100"></h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-200 text-3xl font-light">&times;</button>
        </div>
        <div id="modal-content" class="p-6 overflow-y-auto custom-scrollbar markdown-body">
            <!-- Preview content will be injected here -->
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown-dark.min.css" media="(prefers-color-scheme: dark)">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown-light.min.css" media="(prefers-color-scheme: light)">

<!-- highlight.js for code syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
    mark {
        background-color: #fde047; /* yellow-300 */
        padding: 0.2em 0.1em;
        border-radius: 3px;
        color: black;
    }
    .markdown-body {
        background-color: transparent;
    }
    /* Custom styles for better tables in preview */
    .markdown-body table {
        display: table;
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    .markdown-body th,
    .markdown-body td {
        padding: 0.75rem 1rem;
        border: 1px solid #d0d7de;
    }
    .markdown-body tr:nth-of-type(2n) {
        background-color: #f6f8fa;
    }
    @media (prefers-color-scheme: dark) {
        .markdown-body th,
        .markdown-body td {
            border-color: #30363d;
        }
        .markdown-body tr:nth-of-type(2n) {
            background-color: #161b22;
        }
    }
</style>

<script>
// The JS logic remains the same, only the HTML structure it populates has changed.
// The old script is compatible with the new structure.
const searchForm = document.getElementById('search-form');
const keywordInput = document.getElementById('keyword');
const sourceFilterSelect = document.getElementById('source_filter');
const conversionTypeFilter = document.getElementById('conversion_type_filter');
// File type multi-select elements
let fileTypeCache = {};
let selectedFileTypes = new Set();
const fileTypeBtn = document.getElementById('file_type_dropdown_btn');
const fileTypeDropdown = document.getElementById('file_type_dropdown');
const fileTypeList = document.getElementById('file_type_list');
const fileTypeClearBtn = document.getElementById('file_type_clear');
const fileTypeApplyBtn = document.getElementById('file_type_apply');
const searchTypeSelect = document.getElementById('search_type');
const resultsContainer = document.getElementById('results-container');
const resultsSummary = document.getElementById('results-summary');
const paginationContainer = document.getElementById('pagination-container');
const modal = document.getElementById('preview-modal');
const modalTitle = document.getElementById('modal-title');
const modalContent = document.getElementById('modal-content');

document.addEventListener('DOMContentLoaded', function() {
    // Load sources
    fetch('/api/sources')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                data.data.forEach(source => {
                    const opt = document.createElement('option');
                    opt.value = source;
                    opt.textContent = source;
                    sourceFilterSelect.appendChild(opt);
                });
            }
        }).catch(e => console.error('Error fetching sources:', e));

    // Load conversion type mapping
    const conversionTypeMap = {
        0: 'DIRECT',
        1: 'TEXT_TO_MD',
        2: 'CODE_TO_MD',
        3: 'STRUCTURED_TO_MD',
        4: 'XMIND_TO_MD',
        5: 'IMAGE_TO_MD',
        6: 'VIDEO_METADATA',
        7: 'DRAWIO_TO_MD'
    };
    Object.entries(conversionTypeMap).forEach(([val,label]) => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = label;
        conversionTypeFilter.appendChild(opt);
    });

    // Load file types config
    fetch('/api/config/file-types')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                const labels = data.data.file_type_labels || {};
                fileTypeCache = labels;
                renderFileTypeList();
            }
        }).catch(e => console.error('Error fetching file types:', e));
});

function renderFileTypeList() {
    fileTypeList.innerHTML = '';
    const entries = Object.entries(fileTypeCache).sort((a,b)=>a[0].localeCompare(b[0]));
    entries.forEach(([ext, label]) => {
        const id = `ft_${ext}`;
        const wrapper = document.createElement('label');
        wrapper.className = 'flex items-center gap-2 px-1 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer';
        wrapper.innerHTML = `<input type="checkbox" data-ext="${ext}" id="${id}" class="file-type-checkbox" ${selectedFileTypes.has(ext)?'checked':''}> <span class="text-gray-800 dark:text-gray-200 text-xs">${ext} <span class="text-gray-400">(${label})</span></span>`;
        fileTypeList.appendChild(wrapper);
    });
}

fileTypeBtn.addEventListener('click', ()=>{
    fileTypeDropdown.classList.toggle('hidden');
});
document.addEventListener('click', (e)=>{
    if (!fileTypeDropdown.classList.contains('hidden')) {
        if (!fileTypeDropdown.contains(e.target) && !fileTypeBtn.contains(e.target)) {
            fileTypeDropdown.classList.add('hidden');
        }
    }
});
fileTypeClearBtn.addEventListener('click', ()=>{
    selectedFileTypes.clear();
    renderFileTypeList();
});
fileTypeApplyBtn.addEventListener('click', ()=>{
    // collect selected
    selectedFileTypes = new Set(Array.from(document.querySelectorAll('.file-type-checkbox:checked')).map(cb=>cb.getAttribute('data-ext')));
    fileTypeDropdown.classList.add('hidden');
    performSearch();
});

keywordInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        performSearch();
    }
});

function performSearch(page = 1) {
    // 自动关闭文件类型下拉
    if (!fileTypeDropdown.classList.contains('hidden')) {
        fileTypeDropdown.classList.add('hidden');
    }
    const keyword = keywordInput.value;
    const searchType = searchTypeSelect.value;
    const source = sourceFilterSelect.value;
    const conversionType = conversionTypeFilter.value;
    // 动态读取最新勾选（防止未点击 Apply 的场景）
    const dynamicChecked = Array.from(document.querySelectorAll('.file-type-checkbox:checked')).map(cb=>cb.getAttribute('data-ext'));
    // 若用户在下拉内勾选但未点 Apply，也生效
    const merged = new Set([...selectedFileTypes, ...dynamicChecked]);
    const fileTypesParam = Array.from(merged).join(',');
    if (!keyword) {
        resultsSummary.textContent = 'Please enter a keyword to search.';
        resultsContainer.innerHTML = `<div class="p-12 text-center text-gray-500 dark:text-gray-400">Use the search bar above to find documents.</div>`;
        paginationContainer.innerHTML = '';
        return;
    }
    
    resultsSummary.textContent = 'Searching...';
    resultsContainer.innerHTML = `<div class="p-12 text-center text-gray-500 dark:text-gray-400">Loading results...</div>`;

    let apiUrl = `/api/search?keyword=${encodeURIComponent(keyword)}&search_type=${searchType}&page=${page}`;
    if (source) apiUrl += `&source=${encodeURIComponent(source)}`;
    if (conversionType) apiUrl += `&conversion_types=${encodeURIComponent(conversionType)}`;
    if (fileTypesParam) apiUrl += `&file_types=${encodeURIComponent(fileTypesParam)}`;

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';
            if (data.status === 'success') {
                resultsSummary.textContent = `Found ${data.data.search_info.total_results} results in ${data.data.search_info.search_time}.`;
                
                if (data.data.results.length === 0) {
                    resultsContainer.innerHTML = `<div class="p-12 text-center text-gray-500 dark:text-gray-400">No results found for "${keyword}".</div>`;
                } else {
                    data.data.results.forEach(result => {
                        const resultEl = document.createElement('div');
                        resultEl.className = 'p-6 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150 cursor-pointer';
                        resultEl.setAttribute('onclick', `previewMarkdown(${result.id}, '${result.filename}')`);
                        
                        const fileSize = result.filesize > 1024*1024 ? `${(result.filesize/(1024*1024)).toFixed(2)} MB` : `${(result.filesize/1024).toFixed(2)} KB`;
                        const d = new Date(result.file_modified_time);
                        const pad = (num) => num.toString().padStart(2, '0');
                        const modifiedDate = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
                        const sourceUrlLink = result.source_url ? `<a href="${result.source_url}" target="_blank" class="text-xs text-blue-600 hover:underline dark:text-blue-400" onclick="event.stopPropagation()">URL</a>` : '';

                        resultEl.innerHTML = `
                            <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-400" title="Click to preview content">
                                ${result.filename}
                            </h3>
                            <div class="text-sm text-gray-700 dark:text-gray-300 mt-2">${result.snippet}</div>
                            <div class="flex items-center justify-between mt-3">
                                <div class="text-xs text-gray-400 dark:text-gray-500 flex items-center min-w-0">
                                    <span class="whitespace-nowrap"><b>Source:</b> ${result.source}</span>
                                    <span class="mx-2">|</span>
                                    <span class="whitespace-nowrap"><b>Modified:</b> ${modifiedDate}</span>
                                    <span class="mx-2">|</span>
                                    <span class="whitespace-nowrap"><b>Size:</b> ${fileSize}</span>
                                    <span class="mx-2">|</span>
                                    <span class="whitespace-nowrap"><b>Type:</b> ${result.filetype}</span>
                                    <span class="mx-2">|</span>
                                    <span class="truncate" title="${result.filepath}"><b>Path:</b> ${result.filepath}</span>
                                </div>
                                <div class="flex items-center space-x-4">
                                    ${sourceUrlLink}
                                    <a href="#" onclick="openLocalFile(event, '${result.filepath}')" class="text-xs text-blue-600 hover:underline dark:text-blue-400" title="Click to open original file">
                                        Open File
                                    </a>
                                </div>
                            </div>
                        `;
                        resultsContainer.appendChild(resultEl);
                    });
                }
                renderPagination(data.data.pagination, keyword);
            } else {
                resultsSummary.textContent = 'Search failed.';
                resultsContainer.innerHTML = `<div class="p-12 text-center text-red-500">Search failed: ${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultsSummary.textContent = 'An error occurred during search.';
            resultsContainer.innerHTML = `<div class="p-12 text-center text-red-500">An error occurred during the search.</div>`;
        });
}

function renderPagination(pagination, keyword) {
    paginationContainer.innerHTML = '';
    if (pagination.total_pages <= 1) return;

    let paginationHTML = '<nav class="flex items-center space-x-1">';
    
    const prevDisabled = !pagination.has_prev ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200 dark:hover:bg-gray-600';
    paginationHTML += `<a href="#" onclick="${pagination.has_prev ? `performSearch(${pagination.page - 1})` : 'event.preventDefault()'}" class="px-3 py-2 rounded-md text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 ${prevDisabled}">Prev</a>`;

    const maxPagesToShow = 7;
    let startPage, endPage;
    if (pagination.total_pages <= maxPagesToShow) {
        startPage = 1;
        endPage = pagination.total_pages;
    } else {
        const maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
        const maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;
        if (pagination.page <= maxPagesBeforeCurrent) {
            startPage = 1;
            endPage = maxPagesToShow;
        } else if (pagination.page + maxPagesAfterCurrent >= pagination.total_pages) {
            startPage = pagination.total_pages - maxPagesToShow + 1;
            endPage = pagination.total_pages;
        } else {
            startPage = pagination.page - maxPagesBeforeCurrent;
            endPage = pagination.page + maxPagesAfterCurrent;
        }
    }

    if (startPage > 1) {
        paginationHTML += `<a href="#" onclick="performSearch(1)" class="px-3 py-2 rounded-md text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">1</a>`;
        if (startPage > 2) {
            paginationHTML += `<span class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === pagination.page ? 'bg-blue-600 text-white dark:bg-blue-500' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600';
        paginationHTML += `<a href="#" onclick="performSearch(${i})" class="px-3 py-2 rounded-md text-sm font-medium ${activeClass}">${i}</a>`;
    }

    if (endPage < pagination.total_pages) {
        if (endPage < pagination.total_pages - 1) {
            paginationHTML += `<span class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">...</span>`;
        }
        paginationHTML += `<a href="#" onclick="performSearch(${pagination.total_pages})" class="px-3 py-2 rounded-md text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">${pagination.total_pages}</a>`;
    }

    const nextDisabled = !pagination.has_next ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200 dark:hover:bg-gray-600';
    paginationHTML += `<a href="#" onclick="${pagination.has_next ? `performSearch(${pagination.page + 1})` : 'event.preventDefault()'}" class="px-3 py-2 rounded-md text-sm font-medium bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 ${nextDisabled}">Next</a>`;
    
    paginationHTML += '</nav>';
    paginationContainer.innerHTML = paginationHTML;
}

function previewMarkdown(docId, filename) {
    modalTitle.textContent = filename;
    modalContent.innerHTML = '<p class="p-6 text-center text-gray-500 dark:text-gray-400">Loading preview...</p>';
    modal.classList.remove('hidden');

    fetch(`/api/preview/markdown/${docId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                let finalHtml = data.data.rendered_html;
                const keyword = keywordInput.value.trim();

                if (keyword) {
                    try {
                        const regex = new RegExp(keyword.split(/\s+/).join('|'), 'gi');
                        finalHtml = finalHtml.replace(regex, (match) => `<mark>${match}</mark>`);
                    } catch (e) { console.error("Regex error:", e); }
                }
                
                modalContent.innerHTML = finalHtml;

                // Apply syntax highlighting after content is loaded
                modalContent.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                modalContent.innerHTML = `<p class="p-6 text-red-500">Error: ${data.message}</p>`;
            }
        })
        .catch(error => {
            console.error('Preview Error:', error);
            modalContent.innerHTML = '<p class="p-6 text-red-500">An error occurred while fetching the preview.</p>';
        });
}

function openLocalFile(event, filepath) {
    event.stopPropagation(); // Stop event from bubbling up to the parent div's onclick
    event.preventDefault();
    fetch(`/api/open-file?path=${encodeURIComponent(filepath)}`)
        .then(response => response.json())
        .then(data => {
            console.log('Open file request sent:', data);
            if (data.status !== 'success') {
                alert('Could not open file: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Open file error:', error);
            alert('An error occurred while trying to open the file.');
        });
}

function closeModal() {
    modal.classList.add('hidden');
    modalContent.innerHTML = '';
}

document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}